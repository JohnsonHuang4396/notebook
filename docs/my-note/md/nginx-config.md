# ä¸€åœºäº‹æ•…ï¼Œè®©æˆ‘è®¤è¯†äº† Nginxï¼

# ç¼˜èµ·

> åœ¨ä¸€ä¸ªé£å’Œæ—¥ä¸½çš„ä¸‹åˆï¼Œæˆ‘æ­£ç—´è¿·äºå¸¦è–ªå­¦ä¹ çš„å¿«ä¹ä¸­è€Œä¸å¯è‡ªæ‹”ï¼Œä¸æ›¾æƒ³è¢«ä¸€ä¸ªä»å¤©è€Œé™çš„ BUG æ‰“æ–­äº†æˆ‘çš„~~æ‘¸é±¼~~å­¦ä¹ æ—¶å…‰ã€‚ä½†å½“æˆ‘å®šç›ä¸€çœ‹ï¼Œå¥½å®¶ä¼™ï¼Œè¿™ BUG å®ƒä¸ä¸€èˆ¬å‘ï¼
>
> ä¸‹é¢æ˜¯ BUG æè¿° ğŸ‘‡ ![BUGæè¿°](../imgs/NGINX/BUG_EXPLAIN.excalidraw.png)
>
> WTFï¼è¿˜æœ‰è¿™ç§äº‹ï¼Ÿï¼ğŸ˜¨ å“å¾—æˆ‘èµ¶ç´§æ‰“å¼€ vscode çœ‹æ˜¯ä¸æ˜¯å“ªé‡Œå†™å¤šäº†è·³è½¬é€»è¾‘ï¼Œä½†æ˜¯ä¸€é€šæ’æŸ¥åå¹¶æ²¡æœ‰å‘ç°å¼‚å¸¸ï¼Œæœ€ååªèƒ½ä½¿å‡ºæ¸…ç©ºå¤§æ³•ä½¿æœåŠ¡å™¨ä¸­åªä¿ç•™`index.html`æ–‡ä»¶ï¼Œä½†æ˜¯ BUG è¿˜æ˜¯å­˜åœ¨ ğŸ˜­
>
> åˆ°è¿™é‡Œå°±å·²ç»åŸºæœ¬å¯ä»¥ç¡®å®šä¸æ˜¯å‰ç«¯çš„é—®é¢˜äº†ï¼Œäºæ˜¯ä¹æˆ‘æ‰“å¼€æœåŠ¡å™¨çš„ NGINX é…ç½®æ­£æ‰“ç®—ç”¨æˆ‘çš„~~ç«çœ¼é‡‘ç›~~â€œå››åªçœ¼ç›â€å°†å…¶ä¸­çš„å¦–é­”é¬¼æ€ªä¸€æŠŠæªå‡ºæ—¶ï¼Œæ‰å‘ç°**æˆ‘ä¸ä¼š NGINX é…ç½®**ğŸ˜­ï¼
>
> åœ¨æŠ˜è…¾ä¸€é€šé…ç½®æ–‡ä»¶åˆçŒ›ç¿»å®˜æ–¹æ–‡æ¡£ï¼Œç”šè‡³äºæŠŠ`chatgptè€å¸ˆ`éƒ½å¿«é—®çº¢æ¸©äº†ä¹‹åé—®é¢˜è¿˜æ˜¯æ²¡æœ‰è§£å†³ï¼Œèµ°æŠ•æ— è·¯ä¹‹ä¸‹åªå¾—æ±‚åŠ©äºå¤§ä½¬ï¼Œæƒ³ä¸åˆ°å¤§ä½¬åå‡ åˆ†é’Ÿçš„æ“ä½œå°±è§£å†³äº†é—®é¢˜ï¼
>
> ä¸ªäººç†è§£æ˜¯ç”±äº**æœåŠ¡å™¨çš„ Nginx é…ç½®ä¸­ç¼ºå°‘äº†å¯¹`bigScreen`æ–‡ä»¶è·¯å¾„çš„åŒ¹é…è§„åˆ™**ï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢çš„ä»£ç  ğŸ‘‡ (å¦‚æœç†è§£æœ‰è¯¯æ³è¯·æŒ‡å‡ºï¼Œæ„Ÿæ¿€ä¸å°½)
>
> ```nginx
> location /bigScreen {
>       
> }
> ```
>
> äºæ˜¯ä¹æˆ‘åªéœ€è¦åœ¨å‰ç«¯è°ƒç”¨`window.open`æ—¶åœ¨è·¯å¾„ååŠ ä¸Š`/`æ¥æç¤º NGINX æ˜¯è¦åˆ°æ ¹ç›®å½•ä¸‹æŸ¥è¯¢ index.html æ–‡ä»¶å³å¯ï¼Œè§£å†³åçš„è®¿é—®ç»“æœå¦‚ä¸‹ ğŸ‘‡ ![è®¿é—®ç»“æœ](../imgs/NGINX/FINISH.excalidraw.png)

# è®¤è¯†`Nginx`

ç»æ­¤ä¸€äº‹ï¼Œæˆ‘è®¤è¯†åˆ°äº†è‡ªå·±å¯¹ Nginx çŸ¥è¯†çš„åŒ®ä¹ï¼Œäºæ˜¯ä¹å°†æˆ‘ä»å®˜æ–¹æ–‡æ¡£å’Œ`chatgptè€å¸ˆ`é‚£å­¦ä¹ çš„çŸ¥è¯†ç‚¹æ•´ç†äº†ä¸€ä¸‹ï¼Œä¾¿æœ‰äº†è¿™ç¯‡æ–‡ç« 

> PS: æœ¬æ–‡ä¸»è¦å¯¹ Nginx çš„`http_server`é…ç½®è¿›è¡Œè®²è¿°ï¼Œå¦‚æœä½ æƒ³æ‰¾çš„æ˜¯ä» 0 å¼€å§‹åœ¨æœåŠ¡å™¨é…ç½®`Nginx`çš„æ–¹æ¡ˆï¼Œå¯ä»¥æŸ¥é˜…[å¦‚ä½•ä½¿ç”¨ Nginx æ­å»ºé™æ€æ–‡ä»¶æœåŠ¡å™¨](https://tutorials.tinkink.net/zh-hans/nginx/nginx-static-file-server.html)ï¼Œå¸Œæœ›äº†è§£æ›´è¯¦ç»†çš„é…ç½®ï¼Œè¯·å‰å¾€[å®˜æ–¹æ–‡æ¡£](https://nginx.org/en/docs/)æŸ¥é˜…

## åˆ°åº•ä»€ä¹ˆæ˜¯`Nginx`

ä¸‹é¢æ˜¯æ¥è‡ª`chatgptè€å¸ˆ`çš„å›ç­” ğŸ‘‡ ![What is Nginx from chatgpt](../imgs/NGINX/WHAT_IS_NGINX_CHATGPT.png)

ä¸‹é¢æ˜¯æ¥è‡ª`ç»´åŸºç™¾ç§‘`çš„å›ç­” ğŸ‘‡ ![What is Nginx from Wikipedia](../imgs/NGINX/WHAT_IS_NGINX_WIKI.png)

> ç”±æ­¤å¯ä»¥å¾—å‡ºç»“è®ºï¼š`Nginx`ä½œä¸ºè½»é‡çº§çš„ Web æœåŠ¡å™¨ï¼Œå¯ä»¥èƒœä»»ç»å¤§éƒ¨åˆ†ç½‘ç«™çš„ä»£ç†å·¥ä½œï¼Œç”šè‡³å¯ä»¥ç”¨æ¥åš`è´Ÿè½½å‡è¡¡æœåŠ¡å™¨`ï¼Œå…¶å†…å­˜å°‘ã€ç¨³å®šæ€§é«˜ã€é…ç½®ç®€å•çš„ä¼˜åŠ¿ä½¿å…¶è„±é¢–è€Œå‡º

## åº”è¯¥å¦‚ä½•ä½¿ç”¨`Nginx`

æƒ³è¦ä½¿ç”¨`Nginx`ï¼Œé¦–å…ˆæœ€é‡è¦çš„ï¼Œæ˜¯éœ€è¦ä¸€ä¸ªæœåŠ¡å™¨ ğŸ¶(åºŸè¯)ã€‚ç°åœ¨å‡è®¾å·²ç»æœ‰äº†ä¸€ä¸ªæœåŠ¡å™¨ï¼Œå·²ç»å°†æ‰“åŒ…åçš„å‰ç«¯æ–‡ä»¶ä¸Šä¼ åˆ°äº†æœåŠ¡å™¨ä¸Šï¼Œå¹¶ä¸”å·²ç»åœ¨æœåŠ¡å™¨å®‰è£…äº†`Nginx`ï¼Œé‚£è¯¥å¦‚ä½•ç¼–å†™`Nginxé…ç½®`è®©`Nginx`å¯ä»¥æ­£ç¡®è¿”å›è¯·æ±‚çš„æ–‡ä»¶ï¼Ÿ

ä¸‹é¢æ˜¯ä¸€ä¸ª`Nginxé…ç½®æ–‡ä»¶`çš„åŸºç¡€é…ç½®æè¿° ğŸ‘‡ ![Nginxé…ç½®Map](../imgs/NGINX/NGINX_CONFIG.excalidraw.png)

ä¸‹é¢æ˜¯ä¸€ä»½å¸¦æ³¨é‡Šçš„åŸºç¡€`Nginxé…ç½®`ğŸ‘‡

```nginx
    server {
        # ç›‘å¬ HTTP å’Œ HTTPS ç«¯å£
        listen 80;
        listen 443 ssl http2;

        # å®šä¹‰ server_name è¿™é‡Œæ˜¯ä½ çš„åŸŸåæˆ–ipï¼Œä¸”æ”¯æŒæ­£åˆ™åŒ¹é…ä»¥åŠå¤šè§„åˆ™åŒ¹é…
        server_name example.com www.example.com;

        # server_name *.example.com www.example.*;
        # å¯åŒ¹é…: 1.æ‰€æœ‰ä»¥example.comä¸ºåç¼€çš„åŸŸå 2.æ‰€æœ‰ä»¥www.exampleä¸ºå‰ç¼€çš„åŸŸå

        # server_name .example.com;
        # å¯åŒ¹é…æ‰€æœ‰ä»¥example.comä¸ºåç¼€çš„åŸŸå

        # server_name ~^www\d+\.example\.com$;
        # ä»¥ ~ æ ‡è®°ä¸ºæ­£åˆ™è¡¨è¾¾å¼

        # server_name ~^(www\.)?(?<domain>.+)$;
        # å…è®¸å°†åŒ¹é…åˆ°çš„ domain å€¼ä½œä¸ºå˜é‡ç”¨äºåé¢çš„Nginxé…ç½®

        # server_name _;
        # ç”¨äºåŒ¹é…æ‰€æœ‰åŸŸåã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé€šå¸¸ä½œä¸ºæœ€åä¸€ä¸ªserverå—çš„åŒ¹é…è§„åˆ™å­˜åœ¨ï¼Œä½†ä¸å¯åªä½¿ç”¨è¯¥é…ç½®é¡¹åŒ¹é…

        # é…ç½® SSL
        ssl_certificate /path/to/cert.crt;
        # SSLè¯ä¹¦çš„è·¯å¾„ï¼Œå¿…é¡»ä¸ ssl_certificate_key é…åˆä½¿ç”¨
        ssl_certificate_key /path/to/key.key;
        # SSLå¯†é’¥æ–‡ä»¶çš„è·¯å¾„

        # å®šä¹‰ location åŒºåŸŸ
        location / {
        # ä¸å¸¦å‚æ•°çš„urlåŒ¹é…è§„åˆ™ï¼Œå°†åŒ¹é…æ‰€æœ‰çš„è¯·æ±‚urlï¼Œå¹¶ä½¿ç”¨ä¸‹é¢çš„é…ç½®

            # alias /data/w3/images/;
            # urlåˆ«åï¼Œå¦‚æœurlä¸º`/i/img.png`å°†è¢«è½¬æ¢ä¸º`/data/w3/images/img.png`

            root /data/w3/;
            # ç›´æ¥å†³å®šurlçš„æ ¹ç›®å½•ï¼Œ`/i/img.png`å°†è¢«è½¬æ¢ä¸º`/data/w3/i/images/img.png`

            index  index.html index.htm;
            # é»˜è®¤æ–‡æ¡£åç§°ï¼Œå½“å®¢æˆ·ç«¯è¯·æ±‚`www.example.com`æ—¶ï¼Œå°†é»˜è®¤è¿”å›`/data/w3/index.html`æ–‡ä»¶æˆ–`/data/w3/index.htm`æ–‡ä»¶
            # å¦‚æœæ²¡æœ‰æ–‡ä»¶åŒ¹é…åˆ™æ ¹æ®å…¶ä»–è§„åˆ™å¤„ç†

            try_files $uri $uri/ /index.html;
            # åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æŸ¥è¯¢æ–‡ä»¶
            # å¦‚æœ$urlå¯¹åº”çš„æ–‡ä»¶å­˜åœ¨åˆ™ç›´æ¥è¿”å›è¯¥æ–‡ä»¶ï¼›å¦‚æœä¸å­˜åœ¨åˆ™è¿”å›$url/ä¸‹çš„index.htmlæ–‡ä»¶ï¼›å¦åˆ™è¿”å›æ ¹ç›®å½•ä¸‹çš„/index.htmlæ–‡ä»¶

            # å¼€å¯åå‘ä»£ç†
            proxy_pass http://backend;
            # å°†è¯·æ±‚è½¬å‘è‡³http://backendæœåŠ¡å™¨å¤„ç†ï¼Œå¹¶è¿”å›ä»£ç†æœåŠ¡å™¨çš„å“åº”

            # å®šä¹‰åå‘ä»£ç†å¤´éƒ¨
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Host $http_host;
        }

        # é…ç½® HTTPS é‡å®šå‘
        if ($scheme != "https") {
            return 301 https://$server_name$request_uri;
        }

        # å®šä¹‰ error_page åŒºåŸŸ
        error_page 404 /404.html;
        location = /404.html {
            internal;
        }
    }

    server {
        # ä½ å¯ä»¥ä½¿ç”¨å¤šä¸ªserverå—æ¥åŒ¹é…å¤šä¸ªhost
        ...
    }
```
